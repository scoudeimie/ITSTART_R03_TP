/**
 * Ensemble des fonctions javascript de Tchat Priv√©
 *
 */

/**
 * Fonction qui charge la page d'authentification
 */ 
function authentification() {
	document.location.href='../html/authentification.html';
}	

/**
 * Fonction qui affiche les messages d'un salon (en utilisant jQuery)
 *
 * @param id_salon Id du salon dont on affiche les messages
 */
function afficheSalon(id_salon) {
	// Utilisation de la m√©thode get de jQuery
	var donnees;
	// Liste des infos que l'on envoie
	if (id_salon == undefined) {
		donnees = { action: "messages" };
	} else {
		donnees = { action: "messages", 
		     id_salon: id_salon };
	}
	$.get( "/tchat/php/index.php", 
		   donnees,
	       function( data ) { // Fonction de callback en cas de succ√®s
				// Je mets en forme le contenu re√ßu
				var ctn = "";
				var tabMsgs = data.split("\n");
				for(var i = 0; i < tabMsgs.length; i++) {
					tabMsgs[i] = tabMsgs[i].trim();
					if (tabMsgs[i] != "") {
						var tabMsg = tabMsgs[i].split(";");
						var msgTime = tabMsg[0].split(" ");
						msgTime = msgTime[1];
						var msgUser = tabMsg[1];
						var msgMsg = tabMsg[2];
						ctn += "<p class='message'>" + msgTime;
						ctn += " (<span class='pseudo'>" + msgUser + "</span>)";
						ctn += " : <span class='message'>" + msgMsg + "<span></p>";
					}	
				}
				// Je mets √† jour le contenu du div d'id "messages"
				$("#messages").html(ctn);
		   }
	);
}	

/**
 * Fonction (old) qui affiche les messages d'un salon
 *
 * @param id_salon Id du salon dont on affiche les messages
 */
function afficheSalonOld(id_salon) {
	// Je r√©cup√®re l'objet javascript repr√©sentant la div contenant les messages
	var objMessages = document.getElementById('messages'); 
	// J'instancie la classe me permettant de faire une requ√™te HTTP
	var xmlhttp = new XMLHttpRequest();
	// Je demande l'URL au serveur
	xmlhttp.open("GET", "/tchat/php/index.php?action=messages&id_salon=" + id_salon, true);
	xmlhttp.onreadystatechange = function () {
		if (xmlhttp.readyState == 4 && xmlhttp.status == 200){
			// Je mets en forme le contenu re√ßu
			var ctn = "";
			var tabMsgs = xmlhttp.responseText.split("\n");
			for(var i = 0; i < tabMsgs.length; i++) {
				tabMsgs[i] = tabMsgs[i].trim();
				if (tabMsgs[i] != "") {
					var tabMsg = tabMsgs[i].split(";");
					var msgTime = tabMsg[0].split(" ");
					msgTime = msgTime[1];
					var msgUser = tabMsg[1];
					var msgMsg = tabMsg[2];
					ctn += "<p class='message'>" + msgTime;
					ctn += " (<span class='pseudo'>" + msgUser + "</span>)";
					ctn += " : <span class='message'>" + msgMsg + "<span></p>";
				}	
			}
			// Je modifie le contenu de la div
			objMessages.innerHTML = ctn; 
		}
	};
	xmlhttp.send(null);	
}	

/**
 * Fonction appel√©e pour se d√©connecter
 */
function deconnexion() {
	var res = confirm("√ätes-vous sur de vouloir vous d√©connecter ?");
	if (res == true) {
		$.get( "/tchat/php/index.php", 
				{ action: "adeconnexion" },
				function( data ) { // Fonction de callback en cas de succ√®s
					// Je redirige vers l'URL renvoy√©e
					document.location.href = data;
					// $(location).attr('href', data);
				}
		);		
	} 
}

/**
 * Cette fonction doit √™tre appel√©e r√©guli√®rement pour "raffraichir" 
 * la liste des salons ouverts et √† venir
 */
function updateSalons() {
	// Utilisation de la m√©thode get de jQuery
	$.get( "/tchat/php/index.php", 
		   { action: "salonsouverts" }, // Liste des infos que l'on envoie
	       function( data ) { // Fonction de callback en cas de succ√®s
				// Je mets en forme le contenu re√ßu
				var ctn = "<ul>";
				var tabSalons = data.split("\n");
				for(var i = 0; i < tabSalons.length; i++) {
					tabSalons[i] = tabSalons[i].trim();
					if (tabSalons[i] != "") {
						var tabSalon = tabSalons[i].split(";");
						var salonId = tabSalon[0];
						var salonLibelle = tabSalon[1];
						var salonDelai = tabSalon[2];
						ctn += "<li onclick=\"afficheSalon('" + salonId + "');\" ";
						ctn += "title=\"il reste " + salonDelai + "\">";
						ctn += salonLibelle + "</li>";
					}	
				}
				ctn += "</ul>";
				// Je mets √† jour le contenu du div d'id "divSalOuv"
				$("#divSalOuv").html(ctn);
		   }
	);
	// Utilisation de la m√©thode get de jQuery
	$.get( "/tchat/php/index.php", 
		   { action: "salonsavenir" }, // Liste des infos que l'on envoie
	       function( data ) { // Fonction de callback en cas de succ√®s
				// Je mets en forme le contenu re√ßu
				var ctn = "<ul>";
				var tabSalons = data.split("\n");
				for(var i = 0; i < tabSalons.length; i++) {
					tabSalons[i] = tabSalons[i].trim();
					if (tabSalons[i] != "") {
						var tabSalon = tabSalons[i].split(";");
						var salonOuverture = tabSalon[0];
						var salonLibelle = tabSalon[1];					
						ctn += "<li title=\"" + salonOuverture + "\">";
						ctn += salonLibelle + "</li>";
					}	
				}
				ctn += "</ul>";
				// Je mets √† jour le contenu du div d'id "divSalAve"
				$("#divSalAve").html(ctn);
		   }
	);
}

/**
 * Active ou non le bouton d'envoi de messages
 *
 * @param actif Vrai pour activer, faux pour d√©sactiver
 */
function activeSendMessageButton(actif) {
	$("#bSendMsg").attr("disabled", actif ? false : true);
}	

/**
 * Est appel√©e lorsque le contenu du champs de saisie est modifi√©
 *
 * Suivant le contenu du champs de saisie, active ou non le bouton
 * "envoyer"
 */
function changeSaisie() {
	var msg = $("#message").val();
	msg = msg.trim();
	if (msg == "") {
		activeSendMessageButton(false);
	} else {
		activeSendMessageButton(true);
	}	
}

/** 
 * Envois un message vers le serveur pour y √™tre enregistr√©
 */
function sendMessage() {
	$.post( "/tchat/php/index.php", 
		   { action: "envoimessage",
             msg: $("#message").val()  }, // Liste des infos que l'on envoie
	       function( data ) { // Fonction de callback en cas de succËs
				if (data == "KO") {
					alert("votre message n'a pas √©t√© envoy√©...");
				} else {
					$("#message").val("");
				}
		   }
	);
}